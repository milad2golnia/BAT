#include "../headers/vulnerabilityDetection.h"


void sequenceFunctionCheck(FILE* dotFile, FILE* vulFile){
    //An unuseful:
    char temp[1000];

    //Read number of sequences in this file:
    int numberOfSequences = 0;
    fscanf(vulFile, "%d", &numberOfSequences);
    
    //Process each sequence of functions:
    for (size_t i = 0; i < numberOfSequences; i++)
    {
        //Read number of functions in this sequence:
        int numberOfFunctions = 0;
        fscanf(vulFile, "%d", &numberOfFunctions);

        //Reset call graph:
        fseek(dotFile, 0, SEEK_SET);
        
        //IGNORE DOT FORMAT:
        fgets(temp, 1000, dotFile);
        int start = ftell(dotFile);

        size_t j = 0;
        for (; j < numberOfFunctions; j++)
        {
            //Read next function in this sequence:
            char nextFunctionInChain[1000] = { 0 };
            nextFunctionInChain[0] = '"';
            int result = fscanf(vulFile, "%s", nextFunctionInChain+1);
            nextFunctionInChain[strlen(nextFunctionInChain)] = '\"';
            nextFunctionInChain[strlen(nextFunctionInChain) + 1] = '\0';
            
            int endOfFile = 0;
            int found = 0;
            while(true){

                //Read caller:
                int current = ftell(dotFile);
                char first[2002] = { 0 };
                do{
                    endOfFile = fscanf(dotFile, "%s", first);
                    if(endOfFile == -1){
                        break;
                    }
                }while(strstr(first, "[") != NULL || strstr(first, "}") != NULL);
                
                //Check for end of file;
                if(endOfFile == -1)
                    break;
                
                //Check for match with entry point:
                if(current == start && strcmp(first, nextFunctionInChain) == 0){
                    found = 1;
                    break;;
                }
                //Read '->' from file:
                fscanf(dotFile, "%s", temp);

                //Read called:
                char second[2002] = { 0 };
                fscanf(dotFile, "%s", second);
                if(strcmp(second, nextFunctionInChain) == 0){
                    found = 1;
                    break;
                }
            }
            if(found == 0){
                fgets(temp, 1000, vulFile);
                break;
            }
        }
        if(j == numberOfFunctions){
            printf("Warning: Pattern %d-th from function sequences found!\n", i+1);
        }
    }
    return;
}

void sequenceSyscallCheck(FILE* dotFile, FILE* vulFile){
    //An unuseful:
    char temp[1000];

    //Read number of sequences in this file:
    int numberOfSequences = 0;
    fscanf(vulFile, "%d", &numberOfSequences);
    
    //Process each sequence of functions:
    for (size_t i = 0; i < numberOfSequences; i++)
    {
        //Read number of syscalls in this sequence:
        int numberOfSyscalls = 0;
        fscanf(vulFile, "%d", &numberOfSyscalls);

        //Reset call graph:
        fseek(dotFile, 0, SEEK_SET);
        
        //IGNORE DOT FORMAT:
        fgets(temp, 1000, dotFile);

        size_t j = 0;
        for (; j < numberOfSyscalls; j++)
        {
            //Read next function in this sequence:
            int nextSyscallInChain = 0;
            int result = fscanf(vulFile, "%d", &nextSyscallInChain);
            
            //Read dot file:
            char* endOfFile;
            int found = 0;
            while(true){

                //Read caller:
                char line[2002] = { 0 };
                do{
                    endOfFile = fgets(line, 2002, dotFile);
                    if(endOfFile == NULL){
                        break;
                    }
                }while(strstr(line, "[") == NULL || strstr(line, "}") != NULL);
                
                //Check for end of file;
                if(endOfFile == NULL)
                    break;
                
                //Check syscalls:
                char* nextSyscall = strstr(line, " ");
                while(nextSyscall != NULL){
                    int syscall = 0;
                    sscanf(nextSyscall, "%d", &syscall);
                    if(syscall = nextSyscallInChain){
                        found = 1;
                        break;
                    }
                    nextSyscall = strstr(nextSyscall+1, " ");
                }

                if(found == 1)
                    break;
            }
            if(found == 0){
                fgets(temp, 1000, vulFile);
                break;
            }
        }
        if(j == numberOfSyscalls){
            printf("Warning: Pattern %d-th from syscall sequences found!\n", i+1);
        }
    }
    return;
}